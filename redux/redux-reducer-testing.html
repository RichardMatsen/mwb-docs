<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Simplifying Reducer Testing | MWB Documentation</title>
    <meta name="description" content="Data migration workbench">
    
    
    <link rel="preload" href="/mwb-docs/assets/css/0.styles.f856d471.css" as="style"><link rel="preload" href="/mwb-docs/assets/js/app.a7583053.js" as="script"><link rel="preload" href="/mwb-docs/assets/js/23.d60688de.js" as="script"><link rel="preload" href="/mwb-docs/assets/js/7.8a1efbd8.js" as="script"><link rel="prefetch" href="/mwb-docs/assets/js/14.63eaeec2.js"><link rel="prefetch" href="/mwb-docs/assets/js/2.cd3fbe18.js"><link rel="prefetch" href="/mwb-docs/assets/js/3.e5d6ffde.js"><link rel="prefetch" href="/mwb-docs/assets/js/4.5aee960d.js"><link rel="prefetch" href="/mwb-docs/assets/js/5.31efbd1b.js"><link rel="prefetch" href="/mwb-docs/assets/js/6.a75e5a13.js"><link rel="prefetch" href="/mwb-docs/assets/js/8.43eff26f.js"><link rel="prefetch" href="/mwb-docs/assets/js/9.4257e60b.js"><link rel="prefetch" href="/mwb-docs/assets/js/10.b23970bc.js"><link rel="prefetch" href="/mwb-docs/assets/js/11.21e89f2a.js"><link rel="prefetch" href="/mwb-docs/assets/js/12.c9ded795.js"><link rel="prefetch" href="/mwb-docs/assets/js/13.7569e760.js"><link rel="prefetch" href="/mwb-docs/assets/js/15.15d8439f.js"><link rel="prefetch" href="/mwb-docs/assets/js/16.003eec02.js"><link rel="prefetch" href="/mwb-docs/assets/js/17.d272c3f2.js"><link rel="prefetch" href="/mwb-docs/assets/js/18.28d2d373.js"><link rel="prefetch" href="/mwb-docs/assets/js/19.6f14f780.js"><link rel="prefetch" href="/mwb-docs/assets/js/20.5a0ab772.js"><link rel="prefetch" href="/mwb-docs/assets/js/21.6c516c23.js"><link rel="prefetch" href="/mwb-docs/assets/js/22.eb780789.js"><link rel="prefetch" href="/mwb-docs/assets/js/24.e0c7f95f.js"><link rel="prefetch" href="/mwb-docs/assets/js/25.a03bcc83.js"><link rel="prefetch" href="/mwb-docs/assets/js/26.e7229fbe.js"><link rel="prefetch" href="/mwb-docs/assets/js/27.5b7facd5.js"><link rel="prefetch" href="/mwb-docs/assets/js/28.f7daa03e.js"><link rel="prefetch" href="/mwb-docs/assets/js/29.fa78f538.js"><link rel="prefetch" href="/mwb-docs/assets/js/30.6e46af23.js"><link rel="prefetch" href="/mwb-docs/assets/js/31.9c9aa942.js"><link rel="prefetch" href="/mwb-docs/assets/js/32.2dc8a33b.js"><link rel="prefetch" href="/mwb-docs/assets/js/33.4f0214a4.js"><link rel="prefetch" href="/mwb-docs/assets/js/34.bcdd55ce.js"><link rel="prefetch" href="/mwb-docs/assets/js/35.08bcc98d.js"><link rel="prefetch" href="/mwb-docs/assets/js/36.39c27025.js"><link rel="prefetch" href="/mwb-docs/assets/js/37.2bb75089.js"><link rel="prefetch" href="/mwb-docs/assets/js/38.30e861d1.js">
    <link rel="stylesheet" href="/mwb-docs/assets/css/0.styles.f856d471.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mwb-docs/" class="home-link router-link-active"><!----> <span class="site-name">MWB Documentation</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mwb-docs/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/mwb-docs/measure-calculation/" class="nav-link">Measure Calculation</a></div><div class="nav-item"><a href="/mwb-docs/dashboard-thumbnail/" class="nav-link">DashboardThumbnail</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Redux Store</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-store.html" class="nav-link">Overview</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-middleware.html" class="nav-link">Middleware</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-selector-helpers.html" class="nav-link">Selector Helpers</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-computed-state.html" class="nav-link">Computed State</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-observable-arrays.html" class="nav-link">Observable Arrays</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-reducer-testing.html" class="nav-link router-link-exact-active router-link-active">Reducer Testing</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Testing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/cypress-e2e-tests.html" class="nav-link">Cypress e2e Testing</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/cypress-test-results.html" class="nav-link">Cypress Test Results</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/unit-test-results.html" class="nav-link">Unit Tests</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/code-coverage.html" class="nav-link">Code Coverage</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/webpack-bundle-analyzer-results.html" class="nav-link">Webpack Bundle Analyzer</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/npm-audit.html" class="nav-link">npm audit security report</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/RichardMatsen/mwb-v2-redux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mwb-docs/" class="nav-link">Overview</a></div><div class="nav-item"><a href="/mwb-docs/measure-calculation/" class="nav-link">Measure Calculation</a></div><div class="nav-item"><a href="/mwb-docs/dashboard-thumbnail/" class="nav-link">DashboardThumbnail</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Redux Store</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-store.html" class="nav-link">Overview</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-middleware.html" class="nav-link">Middleware</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-selector-helpers.html" class="nav-link">Selector Helpers</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-computed-state.html" class="nav-link">Computed State</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-observable-arrays.html" class="nav-link">Observable Arrays</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/redux/redux-reducer-testing.html" class="nav-link router-link-exact-active router-link-active">Reducer Testing</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Testing</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/cypress-e2e-tests.html" class="nav-link">Cypress e2e Testing</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/cypress-test-results.html" class="nav-link">Cypress Test Results</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/unit-test-results.html" class="nav-link">Unit Tests</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/code-coverage.html" class="nav-link">Code Coverage</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/webpack-bundle-analyzer-results.html" class="nav-link">Webpack Bundle Analyzer</a></li><li class="dropdown-item"><!----> <a href="/mwb-docs/testing/npm-audit.html" class="nav-link">npm audit security report</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/RichardMatsen/mwb-v2-redux" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Simplifying Reducer Testing</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/mwb-docs/redux/redux-reducer-testing.html#shaping-actions-and-reducers-for-better-tests" class="sidebar-link">Shaping actions and reducers for better tests</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mwb-docs/redux/redux-reducer-testing.html#generic-action-handler" class="sidebar-link">Generic action handler</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mwb-docs/redux/redux-reducer-testing.html#typical-reducer-test-format" class="sidebar-link">Typical reducer test format</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mwb-docs/redux/redux-reducer-testing.html#generic-reducer-tests" class="sidebar-link">Generic reducer tests</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mwb-docs/redux/redux-reducer-testing.html#reducer-sub-state" class="sidebar-link">Reducer sub-state</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/mwb-docs/redux/redux-reducer-testing.html#type-safety-in-actions" class="sidebar-link">Type safety in actions</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="simplifying-reducer-testing"><a href="#simplifying-reducer-testing" aria-hidden="true" class="header-anchor">#</a> Simplifying Reducer Testing</h1> <p>Reducers are pure functions, so testing them is fairly straight forward, just input existing state and action, and check the returned state.</p> <p>However, as more state is added to the store, the standard test format <a href="https://redux.js.org/recipes/writing-tests#reducers" target="_blank" rel="noopener noreferrer">Redux - Writing Tests<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> leads to a lot of verbose boiler plate and tests which are brittle when refactoring state.</p> <h2 id="shaping-actions-and-reducers-for-better-tests"><a href="#shaping-actions-and-reducers-for-better-tests" aria-hidden="true" class="header-anchor">#</a> Shaping actions and reducers for better tests</h2> <p>The effort in testing reducers can be dramatically reduced by adopting certain <strong>conventions</strong>:</p> <ul><li><p>The action payload should have the same shape / properties as the state slice being updated.</p></li> <li><p>Reducer code should be dumb. Any logic in the reducer (translating property name, deriving property values) should be moved to the action.</p></li> <li><p>Actions should have two methods - one that creates the action (for use in tests), and another that dispatches the action (called from application code).</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">createChangeFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">:</span> IFileInfo<span class="token punctuation">)</span><span class="token punctuation">:</span> ActionType <span class="token punctuation">{</span> <span class="token comment">// test this</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">:</span> PageActions<span class="token punctuation">.</span><span class="token constant">CHANGE_FILE</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">changeFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">:</span> IFileInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// call this from components</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>ngRedux<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChangeFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>Reducer and action creator should be tested together. The steps are</p> <ul><li>set up prior state</li> <li>call an action creator</li> <li>pass state and action to the reducer</li> <li>test that the new state is as expected</li></ul></li></ul> <hr> <h2 id="generic-action-handler"><a href="#generic-action-handler" aria-hidden="true" class="header-anchor">#</a> Generic action handler</h2> <p>With the convention of 'dumb reducer', the only work required in the reducer function is the assigment of action.payload properties to corresponding state properties.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">genericActionHandler</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> newState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>state<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> updated <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>newState<span class="token punctuation">,</span> action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> updated<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="typical-reducer-test-format"><a href="#typical-reducer-test-format" aria-hidden="true" class="header-anchor">#</a> Typical reducer test format</h2> <p>Tests are data driven. The configuration object has <code>action</code> and <code>state</code> properties, equating to the reducer parameters and optionally <code>payloadExpectedShape</code>.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReducerTestConfig</span> <span class="token punctuation">{</span>
  action<span class="token punctuation">:</span> object<span class="token punctuation">;</span>
  stateForReducer<span class="token punctuation">:</span> object<span class="token punctuation">;</span>
  payloadExpectedShape<span class="token operator">?</span><span class="token punctuation">:</span> object<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Actions are generated by action creators, which reduces brittleness when refactoring the actions.</p> <p>The test suite for searchReducer shows a typical test when the reducer only uses the generic method.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'searchReducer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> mockNgReduxDispatcher <span class="token operator">=</span> jasmine<span class="token punctuation">.</span><span class="token function">createSpyObj</span><span class="token punctuation">(</span><span class="token string">'mockNgRedux'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'dispatch'</span><span class="token punctuation">,</span> <span class="token string">'getState'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> actions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchActions</span><span class="token punctuation">(</span>mockNgReduxDispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> stateForResetTest <span class="token operator">=</span> <span class="token punctuation">{</span> page<span class="token punctuation">:</span> <span class="token string">'aPage'</span><span class="token punctuation">,</span> pageIsSearchable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> searchTerm<span class="token punctuation">:</span> <span class="token string">'searchForThis'</span><span class="token punctuation">,</span> results<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'result1'</span><span class="token punctuation">,</span> <span class="token string">'result2'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tests <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      action<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token function">createSetPage</span><span class="token punctuation">(</span><span class="token string">'aPage'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> searchInitialState
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      action<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token function">createSetSearchTerm</span><span class="token punctuation">(</span><span class="token string">'searchForThis'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> searchInitialState
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      action<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token function">createSetResultsSuccess</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'result1'</span><span class="token punctuation">,</span> <span class="token string">'result2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> searchInitialState
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      action<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token function">createSetResultsFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> searchInitialState
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      action<span class="token punctuation">:</span> actions<span class="token punctuation">.</span><span class="token function">createResetResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      state<span class="token punctuation">:</span> stateForResetTest
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token function">runAllReducerTests</span><span class="token punctuation">(</span>searchReducer<span class="token punctuation">,</span> tests<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><hr> <h2 id="generic-reducer-tests"><a href="#generic-reducer-tests" aria-hidden="true" class="header-anchor">#</a> Generic reducer tests</h2> <p>The <code>runAllReducerTests</code> function applies a generic set of tests to each action/reducer/state passed in.<br>
These tests include the standard before/after state test performed in a standard reducer test, but can be performed generically because of the convention that payload == state.</p> <p>In addition, it will run</p> <ul><li>test for unknown action (NOP action)</li> <li>tests for immutability</li> <li>sub-state invariance (see below)</li> <li>payload shape tests</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runReducerTests</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> reducer<span class="token punctuation">,</span> action<span class="token punctuation">,</span> expectedShape<span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token function">describe</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`should return state unchanged for nop action`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`should add payload to state`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`should clone the state`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`should not affect other sub state`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should have payload in expected shape'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="reducer-sub-state"><a href="#reducer-sub-state" aria-hidden="true" class="header-anchor">#</a> Reducer sub-state</h2> <p>Some additional functionality comes into play in this application's <strong>page-reducer</strong>.<br>
Since page-reducer's code is common to the validations, referentials, and clinics pages, we pass it the state slice below and the action contains the page name to be changed in <strong>action.subState</strong>.<br>
Only that sub-state of the reducer's state slice is updated.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IPageStateRoot</span> <span class="token punctuation">{</span>
  validations<span class="token operator">?</span><span class="token punctuation">:</span> IPageState<span class="token punctuation">;</span>
  referentials<span class="token operator">?</span><span class="token punctuation">:</span> IPageState<span class="token punctuation">;</span>
  clinics<span class="token operator">?</span><span class="token punctuation">:</span> IPageState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Therefore, in the test spec an additional check ensures that other page data remains unchanged, and are in fact the same object references.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">check_SubState_OtherStateIsUnchanged</span><span class="token punctuation">(</span>inputState<span class="token punctuation">,</span> afterState<span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>action<span class="token punctuation">.</span>subState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>inputState<span class="token punctuation">)</span>
    <span class="token comment">// tslint:disable-next-line:triple-equals</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> key <span class="token operator">!=</span> action<span class="token punctuation">.</span>subState<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>afterState<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span>inputState<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h2 id="type-safety-in-actions"><a href="#type-safety-in-actions" aria-hidden="true" class="header-anchor">#</a> Type safety in actions</h2> <p>One remaining source of bugs not covered by the test is invalid properties in the action payload properties. If the payload added by the action creator is not in the same shape as the expected state shape, the test will not pick up this error.</p> <p>To avoid this, we define types for each state slice and use them in both the state definition and in action creators.</p> <p><strong>In the State definition:</strong></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">type</span> PageState <span class="token operator">=</span> <span class="token punctuation">{</span>
  files<span class="token operator">?</span><span class="token punctuation">:</span> IFileInfo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  fileInfo<span class="token operator">?</span><span class="token punctuation">:</span> IFileInfo<span class="token punctuation">,</span>
  lastRefresh<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  fileCount<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  numVisible<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  visibleFiles<span class="token operator">?</span><span class="token punctuation">:</span> IFileInfo<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  error<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> PageStateRoot <span class="token operator">=</span> <span class="token punctuation">{</span>
  validations<span class="token operator">?</span><span class="token punctuation">:</span> PageState<span class="token punctuation">;</span>
  referentials<span class="token operator">?</span><span class="token punctuation">:</span> PageState<span class="token punctuation">;</span>
  clinics<span class="token operator">?</span><span class="token punctuation">:</span> PageState<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IAppState</span> <span class="token punctuation">{</span>
  pages<span class="token operator">?</span><span class="token punctuation">:</span> PageStateRoot<span class="token punctuation">;</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>In the Action Type definition:</strong></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">type</span> PageActionType <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  payload<span class="token operator">?</span><span class="token punctuation">:</span> PageState<span class="token punctuation">,</span>  <span class="token comment">// Constrain the payload properties to match state</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>In the Action Creators:</strong></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token function">createChangeFile</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">:</span> IFileInfo<span class="token punctuation">)</span><span class="token punctuation">:</span> PageActionType <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span><span class="token punctuation">:</span> PageActions<span class="token punctuation">.</span><span class="token constant">CHANGE_FILE</span><span class="token punctuation">,</span>
    subState<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">PAGE</span><span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      fileInfo<span class="token punctuation">,</span>
      unknownProp<span class="token punctuation">:</span> <span class="token string">'not valid'</span>    <span class="token comment">// Compile time error</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="minimap-container" style="width:250px;" data-v-5f41ee3b><div class="minimap" style="top:250px;zoom:25%;" data-v-5f41ee3b><div data-v-5f41ee3b></div></div></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">9/3/2018, 8:47:06 PM</span></div></div> <!----> </div> <!----></div></div>
    <script src="/mwb-docs/assets/js/23.d60688de.js" defer></script><script src="/mwb-docs/assets/js/7.8a1efbd8.js" defer></script><script src="/mwb-docs/assets/js/app.a7583053.js" defer></script>
  </body>
</html>
